# SolrShield setup

#
# Design goals are
# 1) No requests should cause OOM or DOS (Out Of Memory or Denial Of Service)
# 2) Allow as much request freedom as possible
# 3) Estimate the cost (aka load) of a request and deny it if it is too heavy
#
# A weight is calculated for the separate parts of the query and added to a total weight.
# The total weight goes from 0 and upwards, aiming for ~1000 as cutoff limit.
# Weights are floating point, to allow for scaling factors to be less than 1.
#

solr:
  shield:

    # Simply activating a call comes at a cost
    weight_constant: 100

    # Ideally all fields are listed under 'fields'.
    # 'unlisted_fields' controls handling of requests for unlisted fields
    unlisted_fields:
      allowed: true
      weight: 100

    # The fields section assign base weight to each field.
    # The scale goes from 1 to 1000, where
    # "An integer field" is 1
    # "A DocValued StrField, where the corpus holds a few thousand short unique values" is 5
    # "A DocValued StrField, where the values are mostly unique" is 10
    # "A TextField with a 5-10 words" is 50 (text fields are markedly heavier to process than StrFields)
    # "A TextField with a 100-1000 words" is 100
    # "A TextField with a full transcription of hours of speech" is 1000 (about 50 book pages)
    # "A TextField holding a full book of hundreds of pages" is 5000 (yes, it breaks the scale)
    fields:
      - name: id
        weight: 10
      - name: resource_id
        weight: 10
      - name: origin
        weight: 5

      - name: title
        weight: 50
      - name: abstract
        weight: 50

      - name: freetext 
        weight: 100
      - name: text
        weight: 200
      - name: text_shingles
        weight: 400

    # How to handle parameters not specified in SolrShield.
    # This is shared between all components
    unlisted_params:
      allowed: false
      weight_constant: 1000 # Not used when allowed=false

    # The component section covers the major Solr handlers, such as faceting and highlighting.
    # It also covers grouping and faceting, which are technically not handlers but conceptually on par.
    components:

      # Search covers both the search and the retrieval part of a basic query based request
      search:
        default_enabled: true
        allowed: true
        weight_constant: 100    # The base cost of using the component. params-specific weights will be added

        params:
          q:
            weight_constant: 10
            max_chars: 1000

          fq:
            weight_constant: 0.0
            weight_factor: 10   # There can be multiple filter queries
            max_chars: 1000

          fl:
            default_enabled: true
            weight_factor: 1    # weight_factor will be multiplied to each field weight
            default_fields:     # Must match the ones defined in solrconfig.xml
              - abstract
              - description
              - genre_sub
              - title
              - subtitle
              - alternative_title
              - creator_full_name
              - area
              - topic
              - notes
              - catalog
              - production_place
              - subject_full_name
              - audience
              - text
            denied_fields:      # Blacklist filter (see facet for whitelist ditto)
              - '*'             # The asterisk is used for requesting all fields
              - text_shingles   # No real need for denying, this is just to demonstrate denied_value

          rows:
            default_enabled: true
            default_value: 20   # Must match the one defined in solrconfig.xml
            weight_factor: 0.1  # Multiplied to value and multiplied to fl compound weight
            max_value: 5000     # Hard limit

          start:
            weight_factor: 0.01 # Multiplied to value
            max_value: 1000     # Hard limit

          # Zero cost arguments
          q.op:
          wt:
          version:
          indent:

          # Debug is heavy and should not be widely used. The current weights are chosen so that only a single
          # query debug (rows=1) is possible with a max_weight of 1000. In reality any request will always have
          # some weight even before turning on debug so using debug with rows=2 will exceed the max_weight.
          debug:
            weight_constant: 500 
            weight_factor: 1    # Multiplied to rows, as debug-results is processed for each returned document
          debug.explain.structured:

          # Explicit disabling of defType, overriding a potential unlisted_params.allowed=true
          defType:
            allowed: false

      # Standard Solr faceting
      facet:
        default_enabled: true   # Must match the one defined in solrconfig.xml
        weight_constant: 100
        allowed: true
        allowed_fields:
          - genre_sub
          - title
          - subtitle
          - alternative_title
          - creator_full_name
          - area
          - topic
          - notes
          - catalog

        params:

          facet.query:          # Multiple queries
            allowed: false
          facet.field:          # List of fields
            default_enabled: true
            weight_factor: 1    # Multiplied to (limit multiplied to field weights)
            default_fields:     # Must match the ones defined in solrconfig.xml
              - catalog
              - collection
              - categories
              - genre
              - renre_sub
              - resource_description
              - resource_description_general
              - creator_full_name
              - creator_affiliation
              - subject_full_name
            allowed_fields:     # Must match the ones defined in solrconfig.xml
              - id
              - origin
              - location
              - catalog
              - collection
              - categories
              - genre
              - renre_sub
              - resource_description
              - resource_description_general
              - creator_full_name
              - creator_affiliation
              - subject_full_name
          facet.limit:          # Integer
            default_enabled: true
            default_value: 20   # Must match the one defined in solrconfig.xml
            weight_factor: 0.01
            max_value: 10000    # Hard limit

          # Zero cost facet options
          facet.sort:           # Ordered sort clauses
            max_chars: 100
          facet.mincount:       # Integer
            default_value: 1
          facet.exists:         # Boolean (reduced load, but we don't want negative weights)
            default_value: false

          facet.excludeTerms:   # List of terms
            weight_factor: 0.1

# TODO: facet.range
# TODO: group
# TODO: hl
# TODO: spellcheck
# TODO: DidYouMean
